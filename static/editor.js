// Generated by CoffeeScript 1.4.0
(function() {
  var converter, dragEnter, dragLeave, dragging, fileDrop, redirect, saving, throwerror;

  window.editor = true;

  window.onerror = function(message, url, linenumber) {
    $(".errorbox").html("<div class=\"error\">" + linenumber + " : " + message + "</div>");
    return true;
  };

  converter = null;

  saving = false;

  $(document).ready(function() {
    var hidden, horizontal, html;
    hidden = false;
    horizontal = false;
    $("#drophide").hide();
    $(document).filedrop({
      callback: fileDrop
    });
    $(document).on("dragenter", dragEnter);
    $(document).on("dragleave", dragLeave);
    $(document).on("drop", function() {
      return $("#drophide").hide();
    });
    $('textarea#editor').on('change keyup', function() {
      var html;
      if (hidden) {
        return;
      }
      $(".errorbox").html("");
      html = converter.makeHtml($("#editor").val());
      $("#result").html(html);
    });
    $('textarea#editor').focus();
    if ((location.hash != null) && location.hash !== "") {
      $('input#docname').val(location.hash.replace("#", ""));
    }
    $("#discard").click(function() {
      if (saving) {
        return;
      }
      return redirect();
    });
    $("#save").click(function() {
      var data, name;
      if (saving) {
        return;
      }
      saving = true;
      data = $("#editor").val();
      name = $('input#docname').val();
      $("#save").css({
        "color": "#777"
      });
      $("#discard").css({
        "color": "#777"
      });
      $("#save").html("Saving...");
      ($.post(document.URL, {
        title: name,
        content: data
      })).done(redirect).error(throwerror);
    });
    $("#hide").click(function() {
      var an;
      hidden = !hidden;
      if (hidden) {
        $('#result').fadeOut("fast", function() {
          var an;
          an = horizontal ? {
            bottom: "50px"
          } : {
            width: "935px"
          };
          $('#edcontainer').animate(an);
          $("#hide").text("Show preview");
        });
      } else {
        an = horizontal ? {
          bottom: "51%"
        } : {
          width: "450px"
        };
        $('#edcontainer').animate(an, function() {
          $('#result').fadeIn("fast");
          $("#hide").text("Hide preview");
        });
      }
    });
    $("#switch").click(function() {
      if (hidden) {
        return;
      }
      horizontal = !horizontal;
      if (horizontal) {
        $('#result').animate({
          width: "918px",
          top: "50%"
        });
        return $('#edcontainer').animate({
          width: "938px",
          bottom: "51%"
        });
      } else {
        $('#result').animate({
          width: "460px",
          top: "60px"
        });
        return $('#edcontainer').animate({
          width: "450px",
          bottom: "50px"
        });
      }
    });
    converter = new Showdown.converter();
    html = converter.makeHtml($("#editor").val());
    return $("#result").html(html);
  });

  dragging = 0;

  dragEnter = function() {
    dragging += 1;
    $("#drophide").fadeIn("fast");
    return false;
  };

  dragLeave = function() {
    dragging -= 1;
    if (dragging <= 0) {
      dragging = 0;
      $("#drophide").fadeOut("fast");
    }
    return false;
  };

  fileDrop = function(fileData) {
    var doc, html;
    $("#drophide").fadeOut("fast");
    try {
      doc = JSON.parse(fileData);
    } catch (error) {
      alert("Not a valid Dodo home document");
      return;
    }
    $("#editor").val(doc.data);
    $('input#docname').val(doc.title);
    html = converter.makeHtml($("#editor").val());
    return $("#result").html(html);
  };

  redirect = function(data) {
    location.href = document.URL.replace(/\/edit(.*)/, "");
  };

  throwerror = function(data) {
    alert("Check your console (and logs, if you can)!");
    console.log(data);
  };

}).call(this);
